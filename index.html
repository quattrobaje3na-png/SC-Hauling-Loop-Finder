<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMDR Quattro Logistics Ledger</title>
    <style>
        :root { --accent: #822; --bg: #0a0a0a; --panel: #1a1a1a; --text: #e0e0e0; --border: #333; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, sans-serif; padding: 20px; }
        .ledger-container { max-width: 1300px; margin: 0 auto; }
        .contract-block { background: var(--panel); padding: 25px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 40px; }
        .contract-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); margin-bottom: 20px; padding-bottom: 10px; }
        h3 { color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin: 0 0 15px 0; font-size: 1rem; }
        .form-section { margin-bottom: 25px; padding: 15px; background: #151515; border-radius: 4px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .grid-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        label { font-size: 0.7rem; margin-bottom: 5px; color: #888; text-transform: uppercase; }
        select, input { background: #222; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 2px; }
        .manifest-item { display: grid; grid-template-columns: 1fr 120px 45px; gap: 10px; margin-bottom: 10px; }
        .zone-box { background: #111; padding: 15px; border: 1px solid #222; border-top: 3px solid var(--accent); }
        .pickup-box { border-top-color: #555; }
        .local-manifest { margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; }
        .manifest-row { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 4px 0; border-bottom: 1px solid #222; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 12px 24px; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        .secondary-btn { background: #333; color: white; border: 1px solid #444; padding: 10px; cursor: pointer; text-transform: uppercase; }
        .global-actions { position: sticky; bottom: 20px; background: rgba(10,10,10,0.95); padding: 20px; border: 1px solid var(--accent); display: flex; gap: 15px; z-index: 100; border-radius: 4px; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="ledger-container" id="ledger"></div>
<div class="global-actions">
    <button class="action-btn" onclick="addNewContract()">+ Add New Contract</button>
    <div style="flex-grow: 1;"></div>
    <input type="file" id="import-input" accept=".json" onchange="importLedger(event)" style="display:none">
    <button class="secondary-btn" onclick="document.getElementById('import-input').click()">Import Ledger JSON</button>
    <button class="action-btn" onclick="exportLedger()">Export Full Ledger</button>
</div>

<script>
const starCitizenData = {
    "Stanton": {
        "ArcCorp": ["Area18", "Area04", "Area06", "Area17", "Baijini Point"],
        "Wala": ["Shady Glen Farms", "ArcCorp Mining Area 045", "ArcCorp Mining Area 048", "ArcCorp Mining Area 056", "ArcCorp Mining Area 061", "ArcCorp Processing Center 115", "ArcCorp Processing Center 123"],
        "Lyria": ["Humboldt Mines", "Loveridge Mineral Reserve", "Shubin Mining Facility SAL-2", "Security Depot Lyria-1"],
        "Hurston": ["Lorville", "Everus Harbor", "HUR-L1", "HDMS-Edmond", "HDMS-Oparei"],
        "Daymar": ["Bountiful Harvest Hydroponics", "ArcCorp Mining Area 141", "Kudre Ore", "Shubin Mining Facility SCD-1", "Security Post Moluto", "Security Post Prashad", "Security Post Thaquray", "Jump Town", "Brio's Breaker Yard", "Nuen Waste Management", "Whistlers Crypt", "Yadar Valley", "Dunlow Ridge Aid Shelter", "Eager Flats Aid Shelter", "Tamdon Plains Aid Shelter", "Wolf Point Aid Shelter"],
        "Yela": ["GrimHEX", "ArcCorp Mining Area 157", "Benson Mining Outpost", "Jumptown", "NT-999-XXII", "Security Post Wan"],
        "microTech": ["New Babbage", "Port Tressler", "MIC-L1", "Ghost Hollow"]
    },
    "Pyro": {
        "Pyro I": ["Gray Gardens Depot", "Rustville", "Stag's Rut", "Stanton Gateway"],
        "Pyro II (Monox)": ["Arid Reach", "Jackson's Swap", "Last Ditch", "Ostler's Claim", "Slowburn Depot", "Sunset Mesa", "Yang's Place", "PYR2-L4 (Checkmate Station)"],
        "Pyro III (Bloom)": ["Orbituary (Rough & Ready)", "Prospect Depot", "Bueno Ravine", "Shadowfall (XenoThreat)", "PYR3-L1 (Starlight)", "PYR3-L3 (Patch City)"],
        "Pyro V": ["PYR5-L1 (FARSTAT-5-1)", "PYR5-L2 (Gaslight)", "PYR5-L4 (Rod's Fuel)", "PYR5-L5 (Rat's Nest)"],
        "Pyro VI (Terminus)": ["Ruin Station (XenoThreat)", "Blackrock Exchange", "PYR6-L3 (Endgame)", "PYR6-L4 (Dudley & Daughters)", "PYR6-L5 (Megumi Refueling)"]
    },
    "Nyx": { "Delamar": ["Levski", "Mining Area 157"] }
};

let contractCount = 0;

function addNewContract(data = null) {
    contractCount++;
    const id = contractCount;
    const block = document.createElement('div');
    block.className = 'contract-block';
    block.id = `contract-${id}`;
    block.innerHTML = `
        <div class="contract-header">
            <input type="text" id="title-${id}" maxlength="100" placeholder="Manifest Title (100 char limit)" style="width:70%; background:transparent; border:none; color:var(--accent); font-weight:bold; font-size:1.1rem;">
            <button class="remove-btn" onclick="this.parentElement.parentElement.remove()">Delete Contract</button>
        </div>
        
        <div class="form-section">
            <h3>Pickups</h3>
            <div id="p-single-${id}" class="zone-box pickup-box">
                <div class="grid-3"><select id="ps-sys-${id}" onchange="updateLocs(${id}, 'ps')"></select><select id="ps-reg-${id}" onchange="updateLocs(${id}, 'ps')"></select><select id="ps-loc-${id}"></select></div>
                <div id="ps-manifest-${id}" class="local-manifest"></div>
            </div>
        </div>

        <div class="form-section">
            <h3>Global Commodity Manifest</h3>
            <div id="comm-list-${id}"></div>
            <button class="secondary-btn" onclick="addComm(${id})">+ Add Item</button>
            <div style="margin-top:10px; color:var(--accent); font-weight:bold;">Total SCU: <span id="total-scu-${id}">0</span></div>
        </div>

        <div class="form-section">
            <h3>Deliveries</h3>
            <div id="d-split-container-${id}" class="grid-split hidden">
                <div class="zone-box"><label>Drop A</label><div class="grid-3"><select id="d1-sys-${id}" onchange="updateLocs(${id}, 'd1')"></select><select id="d1-reg-${id}" onchange="updateLocs(${id}, 'd1')"></select><select id="d1-loc-${id}"></select></div><div id="d1-manifest-${id}" class="local-manifest"></div></div>
                <div class="zone-box"><label>Drop B</label><div class="grid-3"><select id="d2-sys-${id}" onchange="updateLocs(${id}, 'd2')"></select><select id="d2-reg-${id}" onchange="updateLocs(${id}, 'd2')"></select><select id="d2-loc-${id}"></select></div><div id="d2-manifest-${id}" class="local-manifest"></div></div>
            </div>
            <div id="d-single-container-${id}" class="zone-box">
                <div class="grid-3"><select id="ds-sys-${id}" onchange="updateLocs(${id}, 'ds')"></select><select id="ds-reg-${id}" onchange="updateLocs(${id}, 'ds')"></select><select id="ds-loc-${id}"></select></div>
                <div id="ds-manifest-${id}" class="local-manifest"></div>
            </div>
            <button class="secondary-btn" style="margin-top:10px;" onclick="toggleSplit(${id}, 'd')">Toggle Split Delivery</button>
        </div>
    `;
    document.getElementById('ledger').appendChild(block);
    initSelectors(id);
    if (!data) addComm(id);
}

function initSelectors(id) {
    ['ps', 'ds', 'd1', 'd2'].forEach(pre => {
        const sys = document.getElementById(`${pre}-sys-${id}`);
        Object.keys(starCitizenData).forEach(s => sys.add(new Option(s, s)));
        updateLocs(id, pre);
    });
}

function updateLocs(id, pre) {
    const sys = document.getElementById(`${pre}-sys-${id}`).value;
    const reg = document.getElementById(`${pre}-reg-${id}`);
    const loc = document.getElementById(`${pre}-loc-${id}`);
    const currentReg = reg.value;
    reg.innerHTML = '';
    Object.keys(starCitizenData[sys]).forEach(r => reg.add(new Option(r, r)));
    if (currentReg && starCitizenData[sys][currentReg]) reg.value = currentReg;
    loc.innerHTML = '';
    starCitizenData[sys][reg.value].forEach(l => loc.add(new Option(l, l)));
}

function addComm(id, name = "", qty = "") {
    const div = document.createElement('div');
    div.className = 'manifest-item';
    div.innerHTML = `<input type="text" value="${name}" placeholder="Item Name" oninput="sync(${id})"><input type="number" value="${qty}" placeholder="SCU" oninput="sync(${id})"><button class="remove-btn" onclick="this.parentElement.remove(); sync(${id});">X</button>`;
    document.getElementById(`comm-list-${id}`).appendChild(div);
    sync(id);
}

function sync(id) {
    let total = 0;
    const items = Array.from(document.querySelectorAll(`#contract-${id} .manifest-item`)).map(i => {
        const q = parseFloat(i.children[1].value) || 0;
        total += q;
        return { n: i.children[0].value || "Unnamed Item", q: q };
    });
    document.getElementById(`total-scu-${id}`).innerText = total;

    const isSplit = !document.getElementById(`d-split-container-${id}`).classList.contains('hidden');
    
    // Update manifests for all active zones
    const zones = isSplit ? ['ps', 'd1', 'd2'] : ['ps', 'ds'];
    zones.forEach(pre => {
        const container = document.getElementById(`${pre}-manifest-${id}`);
        container.innerHTML = `<label style="color:#666">Items for this location:</label>`;
        items.forEach(item => {
            const displayQty = (pre === 'd1' || pre === 'd2') ? (item.q / 2) : item.q;
            container.innerHTML += `<div class="manifest-row"><span>${item.n}</span><span style="color:var(--accent)">${displayQty} SCU</span></div>`;
        });
    });
}

function toggleSplit(id, type) {
    document.getElementById(`d-single-container-${id}`).classList.toggle('hidden');
    document.getElementById(`d-split-container-${id}`).classList.toggle('hidden');
    sync(id);
}

function exportLedger() {
    const data = Array.from(document.querySelectorAll('.contract-block')).map(b => {
        const id = b.id.split('-')[1];
        return {
            title: document.getElementById(`title-${id}`).value,
            comms: Array.from(b.querySelectorAll('.manifest-item')).map(i => ({n: i.children[0].value, q: i.children[1].value}))
        };
    });
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `hauling_ledger.json`;
    a.click();
}

function importLedger(event) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = JSON.parse(e.target.result);
        document.getElementById('ledger').innerHTML = '';
        contractCount = 0;
        data.forEach(c => {
            addNewContract(true);
            const id = contractCount;
            document.getElementById(`title-${id}`).value = c.title;
            document.getElementById(`comm-list-${id}`).innerHTML = '';
            c.comms.forEach(item => addComm(id, item.n, item.q));
        });
    };
    reader.readAsText(event.target.files[0]);
}

window.onload = () => addNewContract();
</script>
</body>
</html>
