<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCS Hauling: JSON Fleet Manager</title>
    <style>
        :root {
            --primary: #ff4d4d;
            --bg: #0d0d0d;
            --card: #1a1a1a;
            --text: #e0e0e0;
            --border: #333;
            --accent: #2a2a2a;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; }

        header {
            border-bottom: 2px solid var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar {
            background: var(--card);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            border: 1px solid var(--border);
        }

        .contract-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            position: relative;
        }

        .section-label { font-size: 0.75rem; color: var(--primary); font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid var(--border); display: block; }
        .row { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 220px; display: flex; flex-direction: column; }
        
        label { font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        select, input { background: var(--accent); border: 1px solid var(--border); color: white; padding: 10px; border-radius: 4px; }

        .manifest-area { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; margin-top: 10px; }
        .step-row { background: #222; padding: 8px; margin-bottom: 5px; border-radius: 4px; display: flex; gap: 10px; border-left: 3px solid var(--primary); }

        .btn { cursor: pointer; border: none; padding: 10px 15px; border-radius: 4px; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        .btn-save { background: #2e7d32; color: white; }
        .btn-load { background: #1565c0; color: white; }
        .btn-add { background: var(--primary); color: white; }
        .btn-delete { background: #aa0000; color: white; padding: 5px 10px; }
        
        #auto-search { flex-grow: 1; padding: 10px; border-radius: 4px; border: 1px solid var(--primary); background: #000; color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>STAR CITIZEN: JSON FLEET LEDGER</h1>
        <div id="status">DB READY</div>
    </header>

    <div class="toolbar">
        <input type="text" id="auto-search" placeholder="Type Contract Name to Auto-Fill..." list="contract-suggestions">
        <datalist id="contract-suggestions"></datalist>
        <button class="btn btn-add" onclick="autoFillSelected()">Load & Fill</button>
        <button class="btn btn-save" onclick="exportToJson()">Export JSON</button>
        <input type="file" id="import-file" style="display:none" onchange="importJson(event)">
        <button class="btn btn-load" onclick="document.getElementById('import-file').click()">Import JSON</button>
    </div>

    <div id="contract-list"></div>
    <button class="btn btn-add" style="width:100%" onclick="addContract()">+ MANUAL ENTRY</button>
</div>

<script>
    const DATA = {
        systems: ["Stanton", "Pyro", "Nyx"],
        regions: {
            "Stanton": ["Crusader", "Hurston", "ArcCorp", "microTech"],
            "Pyro": ["Pyro I", "Pyro II", "Pyro III", "Pyro IV", "Pyro V", "Pyro VI"],
            "Nyx": ["Levski", "Nyx II", "Nyx III"]
        },
        materials: ["Aphorite", "Audio-Visual Equipment", "Beryl", "Carbon", "Copper (Ore)", "Diamond", "Distilled Spirits", "Fresh Food", "Gold", "Iron (Ore)", "Laranite", "Medical Supplies", "Party Favors", "Processed Food", "Quartz (Raw)", "Silicon", "Stims", "Souvenirs", "Waste"]
    };

    let contractDatabase = [];

    function addContract(initialData = null) {
        const id = Date.now() + Math.floor(Math.random() * 1000);
        const html = `
            <div class="contract-card" id="c-${id}" data-id="${id}">
                <button class="btn btn-delete" style="position:absolute; right:15px; top:15px;" onclick="removeElement('c-${id}')">Ã—</button>
                <div class="row">
                    <div class="input-group"><label>Contract Name</label><input type="text" class="c-name" value="${initialData?.name || ''}"></div>
                    <div class="input-group" style="flex:0.5"><label>Payout (aUEC)</label><input type="text" class="c-payout" value="${initialData?.payout || ''}"></div>
                </div>
                <div class="row">
                    <div class="input-group">
                        <span class="section-label">Origin</span>
                        <select class="c-p-system" onchange="updateRegions(this, 'p-reg-${id}')">
                            <option value="">System</option>
                            ${DATA.systems.map(s => `<option value="${s}" ${initialData?.pSystem === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                        <select id="p-reg-${id}" class="c-p-region">
                            <option value="${initialData?.pRegion || ''}">${initialData?.pRegion || 'Select System'}</option>
                        </select>
                        <div class="manifest-area" id="p-man-${id}"></div>
                        <button class="btn" style="font-size:0.6rem" onclick="addManifestItem('p-man-${id}')">+ Pickup</button>
                    </div>
                    <div class="input-group">
                        <span class="section-label">Destination</span>
                        <select class="c-d-system" onchange="updateRegions(this, 'd-reg-${id}')">
                            <option value="">System</option>
                            ${DATA.systems.map(s => `<option value="${s}" ${initialData?.dSystem === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                        <select id="d-reg-${id}" class="c-d-region">
                            <option value="${initialData?.dRegion || ''}">${initialData?.dRegion || 'Select System'}</option>
                        </select>
                        <div class="manifest-area" id="d-man-${id}"></div>
                        <button class="btn" style="font-size:0.6rem" onclick="addManifestItem('d-man-${id}')">+ Delivery</button>
                    </div>
                </div>
            </div>`;
        document.getElementById('contract-list').insertAdjacentHTML('beforeend', html);
        
        // Handle loading nested manifest items if they exist
        if (initialData?.pManifest) initialData.pManifest.forEach(m => addManifestItem(`p-man-${id}`, m));
        if (initialData?.dManifest) initialData.dManifest.forEach(m => addManifestItem(`d-man-${id}`, m));
    }

    function addManifestItem(containerId, mData = null) {
        const html = `
            <div class="step-row">
                <select class="m-item">${DATA.materials.map(m => `<option value="${m}" ${mData?.item === m ? 'selected' : ''}>${m}</option>`).join('')}</select>
                <input type="number" class="m-scu" style="width:60px" value="${mData?.scu || 0}">
                <input type="text" class="m-loc" style="width:80px" value="${mData?.loc || ''}">
            </div>`;
        document.getElementById(containerId).insertAdjacentHTML('beforeend', html);
    }

    function exportToJson() {
        const contracts = [];
        document.querySelectorAll('.contract-card').forEach(card => {
            const contract = {
                name: card.querySelector('.c-name').value,
                payout: card.querySelector('.c-payout').value,
                pSystem: card.querySelector('.c-p-system').value,
                pRegion: card.querySelector('.c-p-region').value,
                dSystem: card.querySelector('.c-d-system').value,
                dRegion: card.querySelector('.c-d-region').value,
                pManifest: Array.from(card.querySelectorAll('#p-man-' + card.dataset.id + ' .step-row')).map(row => ({
                    item: row.querySelector('.m-item').value,
                    scu: row.querySelector('.m-scu').value,
                    loc: row.querySelector('.m-loc').value
                })),
                dManifest: Array.from(card.querySelectorAll('#d-man-' + card.dataset.id + ' .step-row')).map(row => ({
                    item: row.querySelector('.m-item').value,
                    scu: row.querySelector('.m-scu').value,
                    loc: row.querySelector('.m-loc').value
                }))
            };
            contracts.push(contract);
        });
        const blob = new Blob([JSON.stringify(contracts, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `hauling_session_${Date.now()}.json`;
        a.click();
    }

    function importJson(event) {
        const reader = new FileReader();
        reader.onload = e => {
            const imported = JSON.parse(e.target.result);
            contractDatabase = [...contractDatabase, ...imported];
            updateSuggestions();
            alert("Database Updated with " + imported.length + " contracts.");
        };
        reader.readAsText(event.target.files[0]);
    }

    function updateSuggestions() {
        const list = document.getElementById('contract-suggestions');
        list.innerHTML = contractDatabase.map(c => `<option value="${c.name}">`).join('');
    }

    function autoFillSelected() {
        const name = document.getElementById('auto-search').value;
        const match = contractDatabase.find(c => c.name === name);
        if (match) addContract(match);
        else alert("Contract not found in database.");
    }

    function updateRegions(select, targetId) {
        const system = select.value;
        const regionSelect = document.getElementById(targetId);
        regionSelect.innerHTML = DATA.regions[system]?.map(r => `<option value="${r}">${r}</option>`).join('') || '<option value="">N/A</option>';
    }

    function removeElement(id) { document.getElementById(id).remove(); }
</script>
</body>
</html>
