<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMDR Quattro Logistics Ledger</title>
    <style>
        :root { --accent: #822; --bg: #0a0a0a; --panel: #1a1a1a; --text: #e0e0e0; --border: #333; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, sans-serif; padding: 10px; }
        .ledger-container { max-width: 1850px; margin: 0 auto; }
        .contract-block { background: var(--panel); padding: 20px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 30px; }
        .contract-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); margin-bottom: 15px; padding-bottom: 10px; }
        .main-layout { display: grid; grid-template-columns: 1fr 380px 1fr; gap: 20px; align-items: start; }
        .side-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .side-grid.split { grid-template-columns: 1fr 1fr; }
        h2, h3 { color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin: 0; font-size: 1.1rem; margin-bottom: 10px; }
        .input-group { display: flex; flex-direction: column; margin-bottom: 10px; }
        label { font-size: 0.7rem; margin-bottom: 3px; color: #aaa; text-transform: uppercase; }
        select, input { background: #222; border: 1px solid var(--border); color: white; padding: 8px; border-radius: 2px; font-size: 0.85rem; }
        select:focus, input:focus { border-color: var(--accent); outline: none; }
        .manifest-container { background: #151515; padding: 15px; border-radius: 4px; border: 1px solid #222; }
        .manifest-item { display: grid; grid-template-columns: 1fr 80px 30px; gap: 8px; margin-bottom: 8px; align-items: center; }
        .item-split-row { display: grid; grid-template-columns: 1fr 60px; gap: 10px; margin-bottom: 5px; background: #111; padding: 5px; border-radius: 2px; font-size: 0.8rem; border-left: 2px solid var(--accent); }
        .zone-box { background: #111; padding: 15px; border-top: 3px solid #555; }
        .delivery-box { border-top-color: var(--accent); }
        .action-btn { background: var(--accent); color: white; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; }
        .secondary-btn { background: #333; color: white; border: 1px solid #444; padding: 8px; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; }
        .remove-btn { background: transparent; color: #666; border: 1px solid #444; padding: 2px 6px; cursor: pointer; font-size: 0.7rem; }
        .global-actions { position: sticky; bottom: 20px; background: rgba(10,10,10,0.95); padding: 15px; border: 1px solid var(--accent); border-radius: 4px; display: flex; gap: 15px; z-index: 100; }
        .hidden { display: none; }
        #import-input { display: none; }
    </style>
</head>
<body>

<div class="ledger-container" id="ledger"></div>

<div class="global-actions">
    <button class="action-btn" onclick="addNewContract()">+ Add New Contract</button>
    <div style="flex-grow: 1;"></div>
    <input type="file" id="import-input" accept=".json" onchange="importLedger(event)">
    <button class="secondary-btn" onclick="document.getElementById('import-input').click()">Import Ledger JSON</button>
    <button class="action-btn" onclick="exportLedger()">Export Full Ledger</button>
</div>

<script>
const starCitizenData = {
    "Stanton": {
        "ArcCorp": ["Area18", "Area04", "Area06", "Area17", "Baijini Point", "ARC-L1", "ARC-L2", "ARC-L3", "ARC-L4", "ARC-L5"],
        "Wala": ["Shady Glen Farms", "ArcCorp Mining Area 045", "ArcCorp Mining Area 048", "ArcCorp Mining Area 056", "ArcCorp Mining Area 061", "ArcCorp Processing Center 115", "ArcCorp Processing Center 123"],
        "Lyria": ["Humboldt Mines", "Loveridge Mineral Reserve", "Shubin Mining Facility SAL-2", "Security Depot Lyria-1"],
        "Hurston": ["Lorville", "Everus Harbor", "HUR-L1", "HDMS-Edmond", "HDMS-Oparei", "Reclamation & Disposal Orinth"],
        "Crusader": ["Orison", "Seraphim Station", "CRU-L1", "CRU-L4", "CRU-L5"],
        "Cellin": ["Gallete Family Farms", "Terra Mills HydroFarm", "Tram & Myers Mining", "Security Post Criska"],
        "Daymar": ["Bountiful Harvest Hydroponics", "ArcCorp Mining Area 141", "Kudre Ore", "Shubin Mining Facility SCD-1", "Security Post Moluto", "Security Post Prashad", "Security Post Thaquray", "Jump Town", "Brio's Breaker Yard", "Nuen Waste Management", "Whistlers Crypt", "Yadar Valley", "Dunlow Ridge Aid Shelter", "Eager Flats Aid Shelter", "Tamdon Plains Aid Shelter", "Wolf Point Aid Shelter"],
        "Yela": ["GrimHEX", "ArcCorp Mining Area 157", "Benson Mining Outpost", "Jumptown", "NT-999-XXII", "Security Post Wan"],
        "microTech": ["New Babbage", "Port Tressler", "MIC-L1", "MT DataCenter 2UB-RB9-5", "Ghost Hollow"]
    },
    "Pyro": {
        "Pyro I": ["Gray Gardens Depot", "Rustville", "Stag's Rut", "Stanton Gateway"],
        "Pyro II (Monox)": ["Arid Reach", "Jackson's Swap", "Last Ditch", "Ostler's Claim", "Slowburn Depot", "Sunset Mesa", "Yang's Place", "PYR2-L4 (Checkmate Station)"],
        "Pyro III (Bloom)": ["Orbituary (Rough & Ready)", "Prospect Depot", "Bueno Ravine", "Shadowfall (XenoThreat)", "PYR3-L1 (Starlight)", "PYR3-L3 (Patch City)"],
        "Pyro IV": ["Chawla's Beach", "Dinger's Depot", "Fallow Field", "Goner's Deal", "Sacren's Plot"],
        "Pyro V": ["PYR5-L1 (FARSTAT-5-1)", "PYR5-L2 (Gaslight)", "PYR5-L4 (Rod's Fuel)", "PYR5-L5 (Rat's Nest)"],
        "Pyro VI (Terminus)": ["Ruin Station (XenoThreat)", "Blackrock Exchange", "PYR6-L3 (Endgame)", "PYR6-L4 (Dudley & Daughters)", "PYR6-L5 (Megumi Refueling)"]
    },
    "Nyx": { "Delamar": ["Levski", "Mining Area 157"] }
};

let contractCount = 0;

function addNewContract(data = null) {
    contractCount++;
    const id = contractCount;
    const block = document.createElement('div');
    block.className = 'contract-block';
    block.id = `contract-${id}`;
    block.innerHTML = `
        <div class="contract-header">
            <input type="text" id="title-${id}" maxlength="100" placeholder="Manifest Title (100 char limit)" style="width: 500px; font-weight: bold; border: none; background: transparent; color: var(--accent); font-size: 1.1rem;">
            <button class="remove-btn" onclick="removeContract(${id})">DELETE CONTRACT</button>
        </div>
        <div class="main-layout">
            <div class="side-grid" id="p-grid-${id}">
                <div class="zone-box" id="p1-zone-${id}"><label style="color:#888;">PICKUP A</label><div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin: 10px 0;"><select id="p1-sys-${id}" onchange="updateLocs(${id}, 'p1')"></select><select id="p1-reg-${id}" onchange="updateLocs(${id}, 'p1')"></select><select id="p1-loc-${id}"></select></div></div>
                <div class="zone-box hidden" id="p2-zone-${id}"><div style="display:flex; justify-content:space-between;"><label style="color:#888;">PICKUP B</label><button class="remove-btn" onclick="toggleSplit(${id}, 'p')">X</button></div><div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin: 10px 0;"><select id="p2-sys-${id}" onchange="updateLocs(${id}, 'p2')"></select><select id="p2-reg-${id}" onchange="updateLocs(${id}, 'p2')"></select><select id="p2-loc-${id}"></select></div></div>
                <button class="secondary-btn" id="p-split-btn-${id}" onclick="toggleSplit(${id}, 'p')">+ Split Pickup</button>
            </div>
            <div class="manifest-container">
                <h3>Commodities</h3>
                <div id="comm-list-${id}"></div>
                <button class="secondary-btn" onclick="addComm(${id})">+ Add Item</button>
                <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;"><label>Total SCU</label><input type="number" id="total-scu-${id}" value="0" readonly style="border:none; background:transparent; color:var(--accent); font-weight:bold; font-size:1.2rem;"></div>
            </div>
            <div class="side-grid" id="d-grid-${id}">
                <div class="zone-box delivery-box" id="d1-zone-${id}"><label style="color:var(--accent);">DROP A</label><div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin: 10px 0;"><select id="d1-sys-${id}" onchange="updateLocs(${id}, 'd1')"></select><select id="d1-reg-${id}" onchange="updateLocs(${id}, 'd1')"></select><select id="d1-loc-${id}"></select></div><div id="d1-items-${id}"></div></div>
                <div class="zone-box delivery-box hidden" id="d2-zone-${id}"><div style="display:flex; justify-content:space-between;"><label style="color:var(--accent);">DROP B</label><button class="remove-btn" onclick="toggleSplit(${id}, 'd')">X</button></div><div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin: 10px 0;"><select id="d2-sys-${id}" onchange="updateLocs(${id}, 'd2')"></select><select id="d2-reg-${id}" onchange="updateLocs(${id}, 'd2')"></select><select id="d2-loc-${id}"></select></div><div id="d2-items-${id}"></div></div>
                <button class="action-btn" id="d-split-btn-${id}" onclick="toggleSplit(${id}, 'd')">+ Split Delivery</button>
            </div>
        </div>
    `;
    document.getElementById('ledger').appendChild(block);
    initSelectors(id);
    if (!data) addComm(id);
}

function initSelectors(id) {
    ['p1', 'p2', 'd1', 'd2'].forEach(pre => {
        const sys = document.getElementById(`${pre}-sys-${id}`);
        Object.keys(starCitizenData).forEach(s => sys.add(new Option(s, s)));
        updateLocs(id, pre);
    });
}

function updateLocs(id, pre) {
    const sys = document.getElementById(`${pre}-sys-${id}`).value;
    const reg = document.getElementById(`${pre}-reg-${id}`);
    const loc = document.getElementById(`${pre}-loc-${id}`);
    const currentReg = reg.value;
    reg.innerHTML = '';
    Object.keys(starCitizenData[sys]).forEach(r => reg.add(new Option(r, r)));
    if (currentReg && starCitizenData[sys][currentReg]) reg.value = currentReg;
    loc.innerHTML = '';
    starCitizenData[sys][reg.value].forEach(l => loc.add(new Option(l, l)));
}

function addComm(id, name = "", qty = "") {
    const div = document.createElement('div');
    div.className = 'manifest-item';
    div.innerHTML = `<input type="text" value="${name}" placeholder="Item" oninput="sync(${id})"><input type="number" value="${qty}" placeholder="SCU" oninput="calcTotal(${id})"><button class="remove-btn" onclick="this.parentElement.remove(); calcTotal(${id});">X</button>`;
    document.getElementById(`comm-list-${id}`).appendChild(div);
    sync(id);
}

function calcTotal(id) {
    let t = 0;
    document.querySelectorAll(`#contract-${id} input[type="number"]`).forEach(i => { if (i.placeholder === "SCU") t += parseFloat(i.value) || 0; });
    document.getElementById(`total-scu-${id}`).value = t;
    sync(id);
}

function sync(id) {
    const dSplit = !document.getElementById(`d2-zone-${id}`).classList.contains('hidden');
    const items = Array.from(document.querySelectorAll(`#contract-${id} .manifest-item`)).map(i => ({ n: i.children[0].value || "Item", q: parseFloat(i.children[1].value) || 0 }));
    ['d1', 'd2'].forEach(pre => {
        const c = document.getElementById(`${pre}-items-${id}`);
        c.innerHTML = '';
        items.forEach(item => { const val = dSplit ? (item.q / 2) : item.q; c.innerHTML += `<div class="item-split-row"><span>${item.n}</span><span style="color:var(--accent); font-weight:bold;">${val}</span></div>`; });
    });
}

function toggleSplit(id, type) {
    const zone = document.getElementById(`${type === 'p' ? 'p2-zone' : 'd2-zone'}-${id}`);
    const grid = document.getElementById(`${type === 'p' ? 'p-grid' : 'd-grid'}-${id}`);
    const btn = document.getElementById(`${type === 'p' ? 'p-split-btn' : 'd-split-btn'}-${id}`);
    zone.classList.toggle('hidden');
    grid.classList.toggle('split');
    btn.classList.toggle('hidden');
    sync(id);
}

function removeContract(id) { document.getElementById(`contract-${id}`).remove(); }

function exportLedger() {
    const contracts = Array.from(document.querySelectorAll('.contract-block')).map(b => {
        const id = b.id.split('-')[1];
        return {
            title: document.getElementById(`title-${id}`).value,
            pSplit: !document.getElementById(`p2-zone-${id}`).classList.contains('hidden'),
            dSplit: !document.getElementById(`d2-zone-${id}`).classList.contains('hidden'),
            pickupA: { sys: document.getElementById(`p1-sys-${id}`).value, reg: document.getElementById(`p1-reg-${id}`).value, loc: document.getElementById(`p1-loc-${id}`).value },
            pickupB: !document.getElementById(`p2-zone-${id}`).classList.contains('hidden') ? { sys: document.getElementById(`p2-sys-${id}`).value, reg: document.getElementById(`p2-reg-${id}`).value, loc: document.getElementById(`p2-loc-${id}`).value } : null,
            comms: Array.from(b.querySelectorAll('.manifest-item')).map(i => ({ item: i.children[0].value, total: i.children[1].value })),
            dropA: { sys: document.getElementById(`d1-sys-${id}`).value, reg: document.getElementById(`d1-reg-${id}`).value, loc: document.getElementById(`d1-loc-${id}`).value },
            dropB: !document.getElementById(`d2-zone-${id}`).classList.contains('hidden') ? { sys: document.getElementById(`d2-sys-${id}`).value, reg: document.getElementById(`d2-reg-${id}`).value, loc: document.getElementById(`d2-loc-${id}`).value } : null
        };
    });
    const blob = new Blob([JSON.stringify(contracts, null, 2)], { type: "application/json" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `hauling_ledger.json`;
    a.click();
}

function importLedger(event) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = JSON.parse(e.target.result);
        document.getElementById('ledger').innerHTML = '';
        contractCount = 0;
        data.forEach(c => {
            addNewContract(true);
            const id = contractCount;
            document.getElementById(`title-${id}`).value = c.title;
            if (c.pSplit) toggleSplit(id, 'p');
            if (c.dSplit) toggleSplit(id, 'd');
            setField(id, 'p1', c.pickupA);
            if (c.pSplit) setField(id, 'p2', c.pickupB);
            c.comms.forEach(item => addComm(id, item.item, item.total));
            setField(id, 'd1', c.dropA);
            if (c.dSplit) setField(id, 'd2', c.dropB);
            calcTotal(id);
        });
    };
    reader.readAsText(event.target.files[0]);
}

function setField(id, pre, data) {
    document.getElementById(`${pre}-sys-${id}`).value = data.sys;
    updateLocs(id, pre);
    document.getElementById(`${pre}-reg-${id}`).value = data.reg;
    updateLocs(id, pre);
    document.getElementById(`${pre}-loc-${id}`).value = data.loc;
}

window.onload = () => addNewContract();
</script>
</body>
</html>
